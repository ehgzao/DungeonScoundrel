<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>üé¥ Dungeon Scoundrel - Roguelike Card Game</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="A dark medieval roguelike card game. Explore dungeons, fight monsters, collect powerful relics and prove your skill in this challenging card game! 4 difficulties, 50 achievements, permanent unlock system.">
    <meta name="keywords" content="roguelike, card game, medieval, dungeon crawler, RPG, strategy, browser game, HTML5 game, dark fantasy, atmospheric">
    <meta name="author" content="Dungeon Scoundrel Team">
    <meta name="theme-color" content="#2c2416">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://dungeonscoundrel.netlify.app/">
    <meta property="og:title" content="üé¥ Dungeon Scoundrel - Dark Medieval Roguelike Card Game">
    <meta property="og:description" content="A challenging medieval roguelike card game. Explore dungeons, collect relics, defeat monsters! 4 difficulties, 50 achievements. Play now in your browser!">
    <meta property="og:image" content="https://dungeonscoundrel.netlify.app/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Dungeon Scoundrel - Dark Medieval Roguelike Card Game">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Dungeon Scoundrel">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://dungeonscoundrel.netlify.app/">
    <meta name="twitter:title" content="üé¥ Dungeon Scoundrel - Dark Medieval Roguelike">
    <meta name="twitter:description" content="A challenging medieval roguelike card game. Explore dungeons, collect relics, defeat monsters! Play now!">
    <meta name="twitter:image" content="https://dungeonscoundrel.netlify.app/og-image.png">
    <meta name="twitter:image:alt" content="Dungeon Scoundrel - Dark Medieval Roguelike Card Game">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.svg">
    <link rel="mask-icon" href="favicon.svg" color="#d4af37">
    <link rel="apple-touch-icon" href="favicon.svg">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="site.webmanifest">
    
    <!-- Medieval Fonts from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Cinzel+Decorative:wght@700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/styles/styles.css">
    <link rel="stylesheet" href="src/styles/mobile.css">
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script>
        (function(){
            if (window.emailjs) { emailjs.init('JhH3cSIF6g3y73-Yk'); }
        })();
    </script>
    
    <style>
        /* CSS Variables for Design Tokens */
        :root {
            --color-gold: #c9a961;
            --color-gold-dark: #a68948;
            --color-gold-light: #d4af37;
            --color-danger: #ff6b6b;
            --color-success: #6bcf7f;
            --color-warning: #ffd93d;
            --color-info: #4ecdc4;
            --color-bg-dark: #2a2318;
            --color-bg-darker: #1a1410;
            --color-border: #5a4a38;
            
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }
        
        /* Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Pulse Animation */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(107, 207, 127, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(107, 207, 127, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(107, 207, 127, 0); }
        }
        
        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Slide In Animation */
        @keyframes slideInUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Skeleton Loading Animation */
        @keyframes skeleton-loading {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.05) 0px,
                rgba(255, 255, 255, 0.15) 40px,
                rgba(255, 255, 255, 0.05) 80px
            );
            background-size: 200px 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.3s ease;
        }
        
        /* Loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-gold);
            animation: spin 0.8s linear infinite;
        }
        
        /* Mobile CSS now in: src/styles/mobile.css */
        
        /* Shake animation for incorrect answers */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Mobile Waitlist Modal */
        #mobileWaitlistModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1410 0%, #2a1f1a 100%);
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }
        
        #mobileWaitlistModal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .waitlist-container {
            max-width: 500px;
            width: 100%;
            background: rgba(42, 31, 26, 0.95);
            border: 2px solid #5a4a38;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .waitlist-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        .waitlist-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8em;
            color: #ffd700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .waitlist-subtitle {
            font-size: 1.1em;
            color: #ddd;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .waitlist-form {
            margin-top: 30px;
        }
        
        .waitlist-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(201,169,97,0.3);
            border-radius: 6px;
            color: #ddd;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .waitlist-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .waitlist-checkbox-group {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        
        .waitlist-checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            color: #ddd;
            font-size: 0.9em;
            cursor: pointer;
            line-height: 1.5;
        }
        
        .waitlist-checkbox-label input[type="checkbox"] {
            margin-top: 3px;
            width: 18px;
            height: 18px;
            accent-color: #ffd700;
            cursor: pointer;
        }
        
        .waitlist-checkbox-label.required::after {
            content: " *";
            color: #ff6b6b;
        }
        
        .waitlist-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(180deg, #5a4d3f 0%, #443828 100%);
            border: 2px solid #5a4a38;
            border-radius: 8px;
            color: #ffd700;
            font-family: 'Cinzel', serif;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .waitlist-btn:hover {
            background: linear-gradient(180deg, #6a5d4f 0%, #544838 100%);
            border-color: #6b5a48;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }
        
        .waitlist-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .waitlist-desktop-link {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(90, 74, 56, 0.5);
            color: #aaa;
            font-size: 0.85em;
        }
        
        .waitlist-desktop-link a {
            color: #6bcf7f;
            text-decoration: none;
            font-weight: 600;
        }
        
        .waitlist-validation {
            color: #ff6b6b;
            font-size: 0.85em;
            margin-top: 10px;
            display: none;
        }
        
        .waitlist-success {
            display: none;
            padding: 20px;
            background: rgba(107, 207, 127, 0.2);
            border: 2px solid #6bcf7f;
            border-radius: 8px;
            color: #6bcf7f;
            margin-top: 20px;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>

    <!-- Simple anti-spam validation (no external dependencies) -->

</head>
<body>

    <!-- ============================================ -->
    <!-- MOBILE WAITLIST MODAL
    <!-- ============================================ -->
    <div id="mobileWaitlistModal">
        <div class="waitlist-container">
            <div class="waitlist-icon">üì±</div>
            <h1 class="waitlist-title">Coming Soon to Mobile!</h1>
            <p class="waitlist-subtitle">
                Dungeon Scoundrel is being optimized for mobile devices. 
                <strong>Play now on desktop</strong> for the best experience!
            </p>
            
            <div class="waitlist-form">
                <p style="color: #ffd700; margin-bottom: 20px; font-weight: 600;">
                    üéÆ Be the first to know when mobile version launches!
                </p>
                
                <input 
                    type="email" 
                    id="waitlistEmail" 
                    class="waitlist-input" 
                    placeholder="your.email@example.com"
                    autocomplete="email"
                >
                
                <div class="waitlist-checkbox-group">
                    <label class="waitlist-checkbox-label required">
                        <input type="checkbox" id="waitlistPrivacy" required>
                        <span>I accept the <a href="#" style="color: #ffd700;">Privacy Policy</a> and consent to the processing of my personal data in accordance with LGPD</span>
                    </label>
                    
                    <label class="waitlist-checkbox-label required">
                        <input type="checkbox" id="waitlistMarketing" required>
                        <span>I want to receive tips, news, and updates about Dungeon Scoundrel</span>
                    </label>
                </div>
                
                <div id="waitlistValidation" class="waitlist-validation"></div>
                
                <button class="waitlist-btn" onclick="joinWaitlist()">
                    ‚ú® Join Waitlist
                </button>
                
                <div id="waitlistSuccess" class="waitlist-success">
                    <strong>üéâ Success!</strong><br>
                    You're on the list! We'll notify you as soon as the mobile version is ready.
                </div>
            </div>
            
            <div class="waitlist-desktop-link">
                <p>Want to play now?</p>
                <p><a href="#" onclick="dismissMobileWarning()">Continue to desktop version ‚Üí</a></p>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- WELCOME SCREEN
    <!-- ============================================ -->
    <div class="welcome-screen" id="welcomeScreen" style="
        background: url('assets/images/dungeon-bg.webp') center center / cover no-repeat, linear-gradient(180deg, #1a1410 0%, #0d0a08 50%, #000000 100%);
        position: relative;
        overflow: hidden;
    ">
        <!-- Dark Overlay for Readability -->
        <div style="position: absolute; inset: 0; background: rgba(0, 0, 0, 0.65); pointer-events: none; z-index: 1;"></div>
        
        <!-- Vignette Effect -->
        <div style="position: absolute; inset: 0; background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.85) 100%); pointer-events: none; z-index: 2;"></div>
        
        <!-- Noise Texture Overlay -->
        <div style="position: absolute; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px); pointer-events: none; z-index: 3; opacity: 0.5;"></div>
        
        <!-- Content Container -->
        <div style="position: relative; z-index: 4; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px;">
        
        <!-- Title Logo Image -->
        <div style="text-align: center; margin-bottom: 12px;">
            <img src="assets/images/title-logo.webp" alt="Dungeon Scoundrel" style="
                max-width: min(85vw, 800px);
                height: auto;
                display: block;
                margin: 0 auto;
                filter: drop-shadow(0 0 18px rgba(201, 169, 97, 0.45))
                        drop-shadow(0 7px 25px rgba(0, 0, 0, 0.85));
                image-rendering: crisp-edges;
                -webkit-user-drag: none;
            ">
        </div>
        
        <!-- Subtitle -->
        <p style="
            font-family: 'Cinzel', serif;
            font-size: clamp(0.75em, 1.9vw, 0.95em);
            color: #8b7355;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            margin: 10px 0 30px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
            font-weight: 600;
        ">A Roguelike Card Game</p>
        <!-- Menu Buttons Container -->
        <div style="display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 400px; margin-bottom: 20px;">
            <button id="btnWelcomeStart" aria-label="Start a new quest" role="button" style="
                font-family: 'Cinzel', serif;
                font-size: clamp(0.9em, 2.3vw, 1.05em);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                padding: 14px 22px;
                background: linear-gradient(180deg, #c9a961 0%, #a68948 100%);
                border: 2px solid #d4af37;
                box-shadow: 
                    0 0 0 1px #8b7355,
                    inset 0 1px 0 rgba(255, 255, 255, 0.2),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.5),
                    0 4px 12px rgba(0, 0, 0, 0.6);
                color: #1a1410;
                cursor: pointer;
                transition: all 0.2s ease;
                text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 0 1px #8b7355, inset 0 1px 0 rgba(255,255,255,0.3), 0 6px 16px rgba(0,0,0,0.8)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 0 1px #8b7355, inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.5), 0 4px 12px rgba(0,0,0,0.6)'"><span style="font-size: 1.2em;">‚öîÔ∏è</span> Start Quest</button>
            
            <button id="btnLearnToPlay" class="menu-btn-secondary" aria-label="Learn how to play the game" role="button" style="
                font-family: 'Cinzel', serif;
                font-size: clamp(0.85em, 2.2vw, 1em);
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                padding: 12px 18px;
                background: linear-gradient(180deg, #3d3328 0%, #2a2318 100%);
                border: 1px solid #5a4a38;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 8px rgba(0, 0, 0, 0.5);
                color: #c9a961;
                cursor: pointer;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='linear-gradient(180deg, #4a3d2f 0%, #342820 100%)'; this.style.borderColor='#6b5a48'" onmouseout="this.style.background='linear-gradient(180deg, #3d3328 0%, #2a2318 100%)'; this.style.borderColor='#5a4a38'"><span style="font-size: 1.1em;">üìö</span> Learn to Play</button>
            
            <button id="btnWelcomeLeaderboard" class="menu-btn-secondary" aria-label="View hall of fame leaderboard" role="button" style="
                font-family: 'Cinzel', serif;
                font-size: clamp(0.85em, 2.2vw, 1em);
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                padding: 12px 18px;
                background: linear-gradient(180deg, #3d3328 0%, #2a2318 100%);
                border: 1px solid #5a4a38;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 8px rgba(0, 0, 0, 0.5);
                color: #c9a961;
                cursor: pointer;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='linear-gradient(180deg, #4a3d2f 0%, #342820 100%)'; this.style.borderColor='#6b5a48'" onmouseout="this.style.background='linear-gradient(180deg, #3d3328 0%, #2a2318 100%)'; this.style.borderColor='#5a4a38'"><span style="font-size: 1.1em;">üèÜ</span> Hall of Fame</button>
            
            <button id="btnWelcomeSoundboard" class="menu-btn-secondary" style="
                font-family: 'Cinzel', serif;
                font-size: clamp(0.85em, 2.2vw, 1em);
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                padding: 12px 18px;
                background: linear-gradient(180deg, #3d3328 0%, #2a2318 100%);
                border: 1px solid #5a4a38;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 8px rgba(0, 0, 0, 0.5);
                color: #c9a961;
                cursor: pointer;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='linear-gradient(180deg, #4a3d2f 0%, #342820 100%)'; this.style.borderColor='#6b5a48'" onmouseout="this.style.background='linear-gradient(180deg, #3d3328 0%, #2a2318 100%)'; this.style.borderColor='#5a4a38'"><span style="font-size: 1.1em;">üéµ</span> Music Chamber</button>
            
            <button id="btnCodex" class="menu-btn-secondary" aria-label="Open codex (upgrades, relics, achievements)" role="button" style="
                font-family: 'Cinzel', serif;
                font-size: clamp(0.85em, 2.2vw, 1em);
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                padding: 12px 18px;
                background: linear-gradient(180deg, #3d3328 0%, #2a2318 100%);
                border: 1px solid #5a4a38;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 8px rgba(0, 0, 0, 0.5);
                color: #c9a961;
                cursor: pointer;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='linear-gradient(180deg, #4a3d2f 0%, #342820 100%)'; this.style.borderColor='#6b5a48'" onmouseout="this.style.background='linear-gradient(180deg, #3d3328 0%, #2a2318 100%)'; this.style.borderColor='#5a4a38'"><span style="font-size: 1.1em;">üìö</span> Codex</button>
            
            <button id="btnGoogleLogin" class="menu-btn-secondary" style="
                font-family: 'Cinzel', serif;
                font-size: clamp(0.85em, 2.2vw, 1em);
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                padding: 12px 18px;
                background: linear-gradient(180deg, #4a3d2f 0%, #342820 100%);
                border: 1px solid #5a4a38;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 8px rgba(0, 0, 0, 0.5);
                color: #c9a961;
                cursor: pointer;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='linear-gradient(180deg, #5a4d3f 0%, #443828 100%)'; this.style.borderColor='#6b5a48'" onmouseout="this.style.background='linear-gradient(180deg, #4a3d2f 0%, #342820 100%)'; this.style.borderColor='#5a4a38'"><span style="font-size: 1.1em;">‚òÅÔ∏è</span> Cloud Sync</button>
        </div>
        
        <!-- Music Controls (Minimalist) -->
        <div style="width: 100%; max-width: 420px;">
            <div id="nowPlayingDisplay" style="
                text-align: center;
                color: #8b7355;
                font-size: clamp(0.75em, 2vw, 0.9em);
                margin-bottom: 12px;
                font-family: 'Cinzel', serif;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                opacity: 0.8;
            ">Dark Awakening</div>
            <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                <button id="btnWelcomeMusicToggle" title="Play/Pause Music" style="
                    font-size: 1.3em;
                    padding: 8px 16px;
                    background: linear-gradient(180deg, #3d3328 0%, #2a2318 100%);
                    border: 1px solid #5a4a38;
                    color: #c9a961;
                    cursor: pointer;
                    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 8px rgba(0, 0, 0, 0.5);
                    transition: all 0.2s ease;
                ">Play/Pause</button>
                <input type="range" id="welcomeMusicVolume" min="0" max="100" value="40" title="Music Volume" style="
                    width: 140px;
                    height: 6px;
                    cursor: pointer;
                    -webkit-appearance: none;
                    appearance: none;
                    border-radius: 3px;
                    outline: none;
                    border: 1px solid #5a4a38;
                ">
            </div>
        </div>
        
        <!-- Bottom Right Container (Credits + Buttons) -->
        <div style="
            position: fixed;
            bottom: 15px;
            right: 15px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        ">
            <!-- Game Credits -->
            <div style="
                padding: 4px 10px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 4px;
                font-family: 'Cinzel', serif;
                font-size: 0.7em;
                color: rgba(201, 169, 97, 0.6);
                text-align: right;
                letter-spacing: 0.05em;
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
                pointer-events: none;
            ">
                a game by <span style="color: rgba(201, 169, 97, 0.85); font-weight: 600;">Gab Lima</span>
            </div>
            
            <!-- Bug Report Button -->
            <button onclick="document.getElementById('bugReportModal').classList.add('active');" style="
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                background: linear-gradient(135deg, rgba(61, 51, 40, 0.85) 0%, rgba(42, 35, 24, 0.9) 100%);
                border: 1px solid rgba(201, 169, 97, 0.4);
                border-radius: 6px;
                box-shadow: 
                    inset 0 1px 0 rgba(255, 255, 255, 0.05),
                    0 2px 12px rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(4px);
                cursor: pointer;
                transition: all 0.3s ease;
            " onmouseover="this.style.borderColor='rgba(201, 169, 97, 0.8)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.borderColor='rgba(201, 169, 97, 0.4)'; this.style.transform='translateY(0)';" title="Report a bug">
                <span style="
                    font-size: 0.95em;
                    filter: drop-shadow(0 0 3px rgba(201, 169, 97, 0.5));
                ">üêõ</span>
                <span style="
                    font-family: 'Cinzel', serif;
                    font-size: 0.75em;
                    font-weight: 600;
                    color: #c9a961;
                    text-transform: uppercase;
                    letter-spacing: 0.08em;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
                ">Report Bug</span>
            </button>

            <!-- Version Badge -->
            <div onclick="document.getElementById('versionModal').classList.add('active');" style="
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                background: linear-gradient(135deg, rgba(61, 51, 40, 0.85) 0%, rgba(42, 35, 24, 0.9) 100%);
                border: 1px solid rgba(201, 169, 97, 0.4);
                border-radius: 6px;
                box-shadow: 
                    inset 0 1px 0 rgba(255, 255, 255, 0.05),
                    0 2px 12px rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(4px);
                cursor: pointer;
                transition: all 0.3s ease;
            " onmouseover="this.style.borderColor='rgba(201, 169, 97, 0.8)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.borderColor='rgba(201, 169, 97, 0.4)'; this.style.transform='translateY(0)';" title="Click to see what's new!">
                <span style="
                    font-size: 0.95em;
                    filter: drop-shadow(0 0 3px rgba(201, 169, 97, 0.5));
                ">üöÄ</span>
                <span style="
                    font-family: 'Cinzel', serif;
                    font-size: 0.75em;
                    font-weight: 600;
                    color: #c9a961;
                    text-transform: uppercase;
                    letter-spacing: 0.08em;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
                ">v1.4.0</span>
            </div>
        </div>
        
        </div> <!-- Close content container -->
    </div>

    <!-- ============================================ -->
    <!-- MAIN GAME WRAPPER (HIDDEN)
    <!-- ============================================ -->
    <div class="game-wrapper" id="gameWrapper">

        <!-- TOP BAR (STATS, GOLD, SETTINGS) -->
        <div class="top-bar">
            <div class="stats-group">
                <div class="stat-display" id="top-bar-health" title="Current / Max Health" role="status" aria-live="polite">
                    ‚ù§Ô∏è <span class="stat-value" id="health" aria-label="Current health">20</span>
                </div>
                <div class="stat-display" id="top-bar-gold" title="Gold" role="status">
                    ü™ô <span class="stat-value" id="goldAmount" aria-label="Gold amount">0</span>
                </div>
                 <!-- Score removed from here -->
                <div class="stat-display" id="top-bar-dungeon" title="Cards left in Dungeon">
                    üè∞ <span class="stat-value" id="dungeonCount">0</span>
                </div>
                <div class="stat-display" id="top-bar-rooms" title="Rooms Cleared">
                    üö™ <span class="stat-value" id="statRooms">0</span>
                </div>
            </div>
            
            <!-- CENTER GROUP: Relics + Timer + Achievements - ABSOLUTE CENTER -->
            <div style="position: absolute; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; align-items: center;">
                <div class="achievements-compact" id="btnTopRelics" title="üìñ Quick access to Relics encyclopedia - View all relics, their effects, and rarities" style="cursor: pointer; transition: all 0.2s ease;">
                    üìñ <span class="achievement-counter">Relics</span>
                </div>
                <div class="stat-display" id="gameTimer" title="Elapsed Time" style="font-size: 1.1em; font-weight: bold; color: #ffd700;">
                    ‚è±Ô∏è <span class="stat-value">00:00</span>
                </div>
                <div class="achievements-compact" id="achievementsCompact" title="Click to view all achievements" style="cursor: pointer;">
                    üèÜ <span class="achievement-counter" id="achievementCounter">0/50</span>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="music-controls">
                    <button class="settings-btn" id="btnMusicToggle" title="Play/Pause Music">‚èØÔ∏è</button>
                    <input type="range" id="musicVolume" min="0" max="100" value="40" title="Music Volume" 
                           style="width: 80px; height: 20px; vertical-align: middle; margin: 0 5px; cursor: pointer;">
                </div>
                
                <button class="settings-btn btn-danger-style" id="btnTopGiveUp" title="Give Up Run" onclick="tryGiveUp();">üè≥Ô∏è</button>
            </div>
        </div>

        <!-- CENTER AREA (RELICS, STAGE, HOLD) -->
        <div class="center-area">
            
            <!-- LEFT PANEL (PLAYER, RELICS, SHOP) -->
            <div class="left-sidebar">
                <!-- Player Class Info - REDESIGNED -->
                <div style="
                    background: linear-gradient(135deg, rgba(201,169,97,0.2) 0%, rgba(42,35,24,0.9) 100%);
                    border: 3px solid #d4af37;
                    border-radius: 15px;
                    padding: 20px 15px;
                    margin-bottom: 15px;
                    box-shadow: 0 6px 20px rgba(212,175,55,0.5);
                    text-align: center;
                ">
                    <!-- Large Avatar -->
                    <img id="playerAvatar" src="" alt="Avatar" style="
                        width: 130px;
                        height: 130px;
                        border-radius: 12px;
                        border: 4px solid #ffd700;
                        object-fit: cover;
                        box-shadow: 0 2px 10px rgba(255,215,0,0.4);
                        margin: 0 auto 12px auto;
                        display: block;
                    ">
                    
                    <!-- Player Info -->
                    <div id="playerNameDisplay" style="
                        color: #ffd700;
                        font-weight: bold;
                        font-size: 1.3em;
                        font-family: 'Cinzel', serif;
                        text-shadow: 0 2px 6px rgba(0,0,0,0.9);
                        margin-bottom: 5px;
                    "></div>
                    <div id="playerClassDisplay" style="
                        color: #d4af37;
                        font-size: 0.9em;
                        text-transform: uppercase;
                        letter-spacing: 2px;
                        font-weight: 700;
                        margin-bottom: 12px;
                    "></div>
                    
                    <!-- Passive Icons Display -->
                    <div id="passiveIconsDisplay" style="
                        display: flex;
                        gap: 6px;
                        flex-wrap: wrap;
                        justify-content: center;
                        padding-top: 12px;
                        border-top: 2px solid rgba(212,175,55,0.5);
                    ">
                        <!-- Passive icons will be added here dynamically -->
                    </div>
                </div>
                
                <div class="relics-panel" id="relicsPanel">
                    <div class="sidebar-label">Relics</div>
                    <div id="relicsList">
                        <div class="empty-slot">No Relics Yet</div>
                    </div>
                </div>
                <div class="sidebar-action">
                    <button class="btn-shop" id="btnOpenShop">üè∫ Merchant</button>
                </div>
            </div>

            <!-- CENTER STAGE (WEAPON, MESSAGES, CONTROLS) -->
            <div class="center-stage">
                
                <div id="messageArea">
                    <!-- Messages appear here -->
                </div>

                <!-- NEW SCORE DISPLAY -->
                <div class="score-display" id="mainScoreDisplay">
                    <div class="score-label">SCORE</div>
                    <div class="score-value" id="mainScoreValue">0</div>
                </div>

                <div id="center-stage-weapon">
                    <div class="center-stage-label">Equipped Weapon</div>
                    <div class="cards-row" id="equippedWeapon">
                        <div class="empty-slot">No Weapon</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" id="btnDrawRoom" disabled>‚öîÔ∏è Enter Chamber</button>
                    <button class="btn btn-success" id="btnAvoidRoom" disabled>üõ°Ô∏è Evade</button>
                    <button class="btn btn-warning" id="btnUndo" disabled style="display: none;">‚Ü©Ô∏è Undo Last Move</button>
                </div>
            </div>

            <!-- RIGHT PANEL (ABILITY, HOLD, DISCARD, TIMER) -->
            <div class="right-sidebar">
                <!-- Class Ability Button - COMPACT -->
                <div style="
                    margin-bottom: 15px;
                    background: linear-gradient(135deg, rgba(201,169,97,0.1) 0%, rgba(42,35,24,0.6) 100%);
                    border: 2px solid #d4af37;
                    border-radius: 10px;
                    padding: 10px;
                    box-shadow: 0 3px 12px rgba(212,175,55,0.3);
                ">
                    <button id="btnClassAbility" class="btn btn-primary" style="
                        width: 100%;
                        padding: 10px 8px;
                        font-size: 0.9em;
                        font-family: 'Cinzel', serif;
                        background: linear-gradient(180deg, #ffd700 0%, #c9a961 100%);
                        border: 2px solid #d4af37;
                        color: #1a1410;
                        font-weight: bold;
                        position: relative;
                        border-radius: 8px;
                        box-shadow: 0 3px 8px rgba(255,215,0,0.4);
                        transition: all 0.3s ease;
                        cursor: pointer;
                    " 
                    onmouseover="if(!this.disabled) { this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 12px rgba(255,215,0,0.6)'; }"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(255,215,0,0.4)';"
                    title="Class special ability">
                        <span id="abilityIcon" style="font-size: 1.3em; margin-right: 5px;">‚ú®</span>
                        <span id="abilityName" style="font-size: 0.85em;">Ability</span>
                        <div id="abilityCooldownDisplay" style="
                            position: absolute;
                            top: 3px;
                            right: 3px;
                            font-size: 0.6em;
                            background: rgba(255,107,107,0.95);
                            padding: 2px 6px;
                            border-radius: 10px;
                            color: #fff;
                            font-weight: bold;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
                        "></div>
                    </button>
                    <div id="abilityDescription" style="
                        font-size: 0.65em;
                        color: #d4af37;
                        text-align: center;
                        margin-top: 6px;
                        padding: 6px;
                        background: rgba(0,0,0,0.4);
                        border-radius: 5px;
                        line-height: 1.3;
                        border: 1px solid rgba(201,169,97,0.2);
                    "></div>
                </div>
                
                <div class="hold-area">
                    <div class="sidebar-label hold-label">Held Card</div>
                    <div id="holdAreaContainer">
                        <div class="empty-slot" id="holdSlotPlaceholder" style="font-size: 0.85em; line-height: 1.3;">Tap & hold any card<br>to save for later</div>
                    </div>
                </div>
                
                <div class="sidebar-label discard-label">Discard</div>
                <div id="discardPilePreview">
                    <!-- Discard mini-cards -->
                </div>
                
                <!-- Timer moved to top-bar -->
            </div>

        </div>

        <!-- BOTTOM BAR (ROOM / "HAND") -->
        <div class="bottom-bar" id="room">
            <!-- The 4 room cards appear here -->
            <div class="empty-slot">Click "Enter Dungeon" to start</div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODALS
    <!-- ============================================ -->

    <!-- Modal: New Game -->
    <div class="modal-overlay" id="newGameModal">
        <div class="modal-content" style="max-width: 600px !important; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="document.getElementById('newGameModal').classList.remove('active');">‚úï</button>
            <h2>‚ú® New Game</h2>
            <div class="form-group">
                <label for="playerNameInput">üë§ Player Name (3-10 characters) *</label>
                <input type="text" id="playerNameInput" placeholder="Enter your name" minlength="3" maxlength="10" required>
                <div id="nameError" style="display: none; color: #ff6b6b; font-size: 0.9em; margin-top: 5px; font-weight: bold;"></div>
                <small style="color: #aaa; font-size: 0.85em;">Minimum 3, maximum 10 characters</small>
            </div>
            <div class="form-group">
                <label>üî• Difficulty</label>
                <div class="difficulty-selector" id="difficultySelector">
                    <button class="difficulty-btn easy" data-difficulty="easy">
                        üü¢ Easy<br><small>20 HP | 30 ü™ô</small>
                    </button>
                    <button class="difficulty-btn normal selected" data-difficulty="normal">
                        üü° Normal<br><small>15 HP | 15 ü™ô</small>
                    </button>
                    <button class="difficulty-btn hard" data-difficulty="hard">
                        üî¥ Hard<br><small>10 HP | 0 ü™ô</small>
                    </button>
                    <button class="difficulty-btn endless" data-difficulty="endless">
                        ‚ôæÔ∏è Endless<br><small>15 HP | 15 ü™ô</small>
                    </button>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 0.9em; color: #ddd; line-height: 1.5;">
                    <strong>‚öîÔ∏è Weapon Durability:</strong> Easy: 3 | Normal: 2 | Hard: 1 | Endless: 2
                    <br><br><strong>üíé Gold & Events:</strong>
                    <br>‚Ä¢ <strong>üü¢ Easy:</strong> More gold & events (40%)
                    <br>‚Ä¢ <strong>üü° Normal:</strong> Balanced (30%)
                    <br>‚Ä¢ <strong>üî¥ Hard:</strong> Less gold & events (20%)
                    <br><br><strong>‚Ü©Ô∏è Undo:</strong> Available on Easy & Normal only
                    <br><br><strong>üëπ Boss Battles:</strong> 2 Minibosses (room 15 & 25) + Final Boss!
                    <br><br><strong>Higher difficulty = Bigger score multiplier!</strong>
                </div>
            </div>
            <div class="modal-controls">
                <button class="btn btn-success" id="btnStartGameModal">‚öîÔ∏è Start Quest!</button>
                <button class="btn btn-secondary" id="btnCancelStart">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Class Selection -->
    <div class="modal-overlay" id="classSelectionModal">
        <div class="modal-content" style="max-width: 1000px !important; width: 90vw !important; padding: 40px 30px !important;">
            <h2 id="classSelectionTitle" style="text-align: center; font-family: 'Cinzel', serif; color: #c9a961; margin-bottom: 10px;">‚öîÔ∏è SELECT YOUR HERO</h2>
            <p id="classSelectionSubtitle" style="text-align: center; color: #8b7355; font-size: 0.9em; margin-bottom: 20px; min-height: 20px;"></p>
            
            <!-- Class Avatars (Horizontal) -->
            <div style="display: flex; gap: 20px; margin-bottom: 25px; justify-content: center; flex-wrap: wrap;">
                <!-- Scoundrel -->
                <div class="class-card" data-class="scoundrel" style="
                    background: linear-gradient(180deg, #2a2318 0%, #1a1410 100%);
                    border: 2px solid #5a4a38;
                    border-radius: 8px;
                    padding: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: center;
                    flex: 0 0 auto;
                    width: 240px;
                    box-sizing: border-box;
                " onmouseover="this.style.borderColor='#c9a961'; this.style.transform='translateY(-5px)'" onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#5a4a38'; this.style.transform='translateY(0)' }">
                    <div style="width: 216px; height: 324px; overflow: hidden; border-radius: 4px; border: 2px solid #5a4a38; margin: 0 auto 8px auto;">
                        <picture>
                            <source srcset="assets/images/avatar-scoundrel.webp" type="image/webp">
                            <img src="assets/images/avatar-scoundrel.jpg" alt="Scoundrel" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                        </picture>
                    </div>
                    <h3 style="color: #c9a961; font-family: 'Cinzel', serif; margin: 0; font-size: 1em;">SCOUNDREL</h3>
                </div>
                
                <!-- Knight -->
                <div class="class-card" data-class="knight" style="
                    background: linear-gradient(180deg, #2a2318 0%, #1a1410 100%);
                    border: 2px solid #5a4a38;
                    border-radius: 8px;
                    padding: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: center;
                    flex: 0 0 auto;
                    width: 240px;
                    box-sizing: border-box;
                " onmouseover="this.style.borderColor='#c9a961'; this.style.transform='translateY(-5px)'" onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#5a4a38'; this.style.transform='translateY(0)' }">
                    <div style="width: 216px; height: 324px; overflow: hidden; border-radius: 4px; border: 2px solid #5a4a38; margin: 0 auto 8px auto;">
                        <picture>
                            <source srcset="assets/images/avatar-knight.webp" type="image/webp">
                            <img src="assets/images/avatar-knight.jpg" alt="Knight" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                        </picture>
                    </div>
                    <h3 style="color: #c9a961; font-family: 'Cinzel', serif; margin: 0; font-size: 1em;">KNIGHT</h3>
                </div>
                
                <!-- Rogue -->
                <div class="class-card" data-class="rogue" style="
                    background: linear-gradient(180deg, #2a2318 0%, #1a1410 100%);
                    border: 2px solid #5a4a38;
                    border-radius: 8px;
                    padding: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: center;
                    flex: 0 0 auto;
                    width: 240px;
                    box-sizing: border-box;
                " onmouseover="this.style.borderColor='#c9a961'; this.style.transform='translateY(-5px)'" onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#5a4a38'; this.style.transform='translateY(0)' }">
                    <div style="width: 216px; height: 324px; overflow: hidden; border-radius: 4px; border: 2px solid #5a4a38; margin: 0 auto 8px auto;">
                        <picture>
                            <source srcset="assets/images/avatar-rogue.webp" type="image/webp">
                            <img src="assets/images/avatar-rogue.jpg" alt="Rogue" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                        </picture>
                    </div>
                    <h3 style="color: #c9a961; font-family: 'Cinzel', serif; margin: 0; font-size: 1em;">ROGUE</h3>
                </div>
                
                <!-- Dancer -->
                <div class="class-card" data-class="dancer" style="
                    background: linear-gradient(180deg, #2a2318 0%, #1a1410 100%);
                    border: 2px solid #5a4a38;
                    border-radius: 8px;
                    padding: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: center;
                    flex: 0 0 auto;
                    width: 240px;
                    box-sizing: border-box;
                " onmouseover="this.style.borderColor='#c9a961'; this.style.transform='translateY(-5px)'" onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#5a4a38'; this.style.transform='translateY(0)' }">
                    <div style="width: 216px; height: 324px; overflow: hidden; border-radius: 4px; border: 2px solid #5a4a38; margin: 0 auto 8px auto;">
                        <picture>
                            <source srcset="assets/images/avatar-dancer.webp" type="image/webp">
                            <img src="assets/images/avatar-dancer.jpg" alt="Dancer" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                        </picture>
                    </div>
                    <h3 style="color: #c9a961; font-family: 'Cinzel', serif; margin: 0; font-size: 1em;">DANCER</h3>
                </div>
                
                <!-- Berserker -->
                <div class="class-card" data-class="berserker" style="
                    background: linear-gradient(180deg, #2a2318 0%, #1a1410 100%);
                    border: 2px solid #5a4a38;
                    border-radius: 8px;
                    padding: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: center;
                    flex: 0 0 auto;
                    width: 240px;
                    box-sizing: border-box;
                " onmouseover="this.style.borderColor='#c9a961'; this.style.transform='translateY(-5px)'" onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#5a4a38'; this.style.transform='translateY(0)' }">
                    <div style="width: 216px; height: 324px; overflow: hidden; border-radius: 4px; border: 2px solid #5a4a38; margin: 0 auto 8px auto;">
                        <picture>
                            <source srcset="assets/images/avatar-berserker.webp" type="image/webp">
                            <img src="assets/images/avatar-berserker.jpg" alt="Berserker" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                        </picture>
                    </div>
                    <h3 style="color: #c9a961; font-family: 'Cinzel', serif; margin: 0; font-size: 1em;">BERSERKER</h3>
                </div>
                
                <!-- Priest -->
                <div class="class-card" data-class="priest" style="
                    background: linear-gradient(180deg, #2a2318 0%, #1a1410 100%);
                    border: 2px solid #5a4a38;
                    border-radius: 8px;
                    padding: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: center;
                    flex: 0 0 auto;
                    width: 240px;
                    box-sizing: border-box;
                " onmouseover="this.style.borderColor='#c9a961'; this.style.transform='translateY(-5px)'" onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#5a4a38'; this.style.transform='translateY(0)' }">
                    <div style="width: 216px; height: 324px; overflow: hidden; border-radius: 4px; border: 2px solid #5a4a38; margin: 0 auto 8px auto;">
                        <picture>
                            <source srcset="assets/images/avatar-priest.webp" type="image/webp">
                            <img src="assets/images/avatar-priest.jpg" alt="Priest" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                        </picture>
                    </div>
                    <h3 style="color: #c9a961; font-family: 'Cinzel', serif; margin: 0; font-size: 1em;">PRIEST</h3>
                </div>
            </div>
            
            <!-- Class Description -->
            <div id="classDescription" style="
                background: rgba(0,0,0,0.4);
                border: 1px solid #5a4a38;
                border-radius: 8px;
                padding: 20px;
                min-height: 150px;
                margin-bottom: 20px;
                display: none;
            ">
                <h3 id="classDescTitle" style="color: #c9a961; font-family: 'Cinzel', serif; margin-top: 0;"></h3>
                <p id="classDescMotivation" style="color: #d4af37; font-style: italic; margin-bottom: 15px;"></p>
                <p id="classDescMechanics" style="color: #ddd; line-height: 1.6;"></p>
            </div>
            
            <div class="modal-controls">
                <button class="btn btn-success" id="btnConfirmClass" disabled>‚öîÔ∏è Begin Adventure!</button>
                <button class="btn btn-secondary" id="btnCancelClass">Back</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Interactive Tutorial -->
    <div class="modal-overlay" id="interactiveTutorialModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="document.getElementById('interactiveTutorialModal').classList.remove('active');">‚úï</button>
            <h2 id="tutorialStepTitle">üéÆ Interactive Tutorial</h2>
            <div id="tutorialStepContent" style="min-height: 300px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 8px; margin: 20px 0;">
                <!-- Dynamic content here -->
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button class="btn btn-secondary" id="btnTutorialPrev" disabled>‚¨ÖÔ∏è Previous</button>
                <button class="btn btn-primary" id="btnTutorialNext">‚û°Ô∏è Next</button>
                <button class="btn btn-secondary" id="btnTutorialSkip">‚è© Skip Tutorial</button>
            </div>
            <div style="text-align: center; margin-top: 15px; color: #aaa; font-size: 0.9em;">
                Step <span id="tutorialCurrentStep">1</span> of <span id="tutorialTotalSteps">8</span>
            </div>
        </div>
    </div>
    
    <!-- Modal: Learn to Play Selection -->
    <div class="modal-overlay" id="learnToPlayModal" role="dialog" aria-modal="true" aria-labelledby="learnToPlayTitle">
        <div class="modal-content" style="max-width: 600px; padding: 40px;">
            <button class="modal-close-btn" onclick="document.getElementById('learnToPlayModal').classList.remove('active');" aria-label="Close learn to play modal">‚úï</button>
            <h2 id="learnToPlayTitle" style="text-align: center; color: #c9a961; margin-bottom: 30px; font-size: 2em;">üìö Learn to Play</h2>
            
            <p style="text-align: center; color: #c9a961; margin-bottom: 30px; font-size: 1.05em;">
                Choose how you want to learn:
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button id="btnStartInteractiveTutorial" style="
                    font-family: 'Cinzel', serif;
                    font-size: 1em;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.08em;
                    padding: 18px 24px;
                    background: linear-gradient(180deg, #c9a961 0%, #a68948 100%);
                    border: 2px solid #d4af37;
                    border-radius: 8px;
                    box-shadow: 
                        0 0 0 1px #8b7355,
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        0 4px 12px rgba(0, 0, 0, 0.6);
                    color: #1a1410;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-align: left;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 0 1px #8b7355, inset 0 1px 0 rgba(255,255,255,0.3), 0 6px 16px rgba(0,0,0,0.8)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 0 1px #8b7355, inset 0 1px 0 rgba(255,255,255,0.2), 0 4px 12px rgba(0,0,0,0.6)'">
                    <div style="font-size: 1.3em; margin-bottom: 8px;">üéì Interactive Tutorial</div>
                    <div style="font-size: 0.8em; font-weight: 400; opacity: 0.8; letter-spacing: 0.05em; text-transform: none;">
                        Play through a guided tutorial with step-by-step instructions
                    </div>
                </button>
                
                <button id="btnOpenRulesReference" style="
                    font-family: 'Cinzel', serif;
                    font-size: 1em;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.08em;
                    padding: 18px 24px;
                    background: linear-gradient(180deg, #3d3328 0%, #2a2318 100%);
                    border: 2px solid #5a4a38;
                    border-radius: 8px;
                    box-shadow: 
                        inset 0 1px 0 rgba(255, 255, 255, 0.05),
                        0 2px 8px rgba(0, 0, 0, 0.5);
                    color: #c9a961;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-align: left;
                " onmouseover="this.style.background='linear-gradient(180deg, #4a3d2f 0%, #342820 100%)'; this.style.borderColor='#6b5a48'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(180deg, #3d3328 0%, #2a2318 100%)'; this.style.borderColor='#5a4a38'; this.style.transform='translateY(0)'">
                    <div style="font-size: 1.3em; margin-bottom: 8px;">üìñ Rules Reference</div>
                    <div style="font-size: 0.8em; font-weight: 400; opacity: 0.8; letter-spacing: 0.05em; text-transform: none;">
                        Read the complete game rules and mechanics at your own pace
                    </div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Rules Reference -->
    <div class="modal-overlay" id="tutorialModal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('tutorialModal').classList.remove('active');">‚úï</button>
            <h2>üìñ Rules Reference</h2>
            
            <div class="tutorial-section">
                <h3>üéØ Objective</h3>
                <p>Clear all cards from the Dungeon deck without your health reaching zero!</p>
            </div>

            <div class="tutorial-section">
                <h3>üéÆ Gameplay</h3>
                <p><strong>1. Start the Action:</strong></p>
                <p>‚Ä¢ Choose <strong>"Enter Dungeon"</strong> (draws 4 cards) or <strong>"Avoid Dungeon"</strong> (discards 3 cards from the top). You cannot avoid two dungeons in a row.</p>
                <p><strong>2. Clear the Dungeon:</strong></p>
                <p>‚Ä¢ You must use or discard all 4 cards from the dungeon (in the bottom bar) to advance.</p>
            </div>

            <div class="tutorial-section">
                <h3>üÉè Card Types</h3>
                <p>
                    <span class="tutorial-card-demo monster">‚ô†Ô∏è ‚ô£Ô∏è Monsters (Spades & Clubs)</span>
                    <br>Click to fight. You take damage = (Monster Value) - (Your Weapon Value). If your weapon is stronger, you take no damage.
                </p>
                <p>
                    <span class="tutorial-card-demo weapon">‚ô¶Ô∏è Weapons (Diamonds)</span>
                    <br>Click to equip. Replaces your current weapon.
                </p>
                <p>
                    <span class="tutorial-card-demo potion">‚ô•Ô∏è Potions (Hearts)</span>
                    <br>Click to heal. Limit of 1 potion per dungeon!
                </p>
            </div>

            <div class="tutorial-section">
                <h3>üìå "Hold" System</h3>
                <p><strong>Tap & hold</strong> (or <strong>right-click</strong> on desktop) cards in the room (bottom bar) to save them in the "Held" area (right sidebar).</p>
                <p>‚Ä¢ <strong>Can hold:</strong> Weapons ‚öîÔ∏è, Potions üíä, and Specials ‚ú®</p>
                <p>‚Ä¢ <strong>Cannot hold:</strong> Monsters üëπ (must be fought immediately!)</p>
                <p>‚Ä¢ Only 1 card can be held at a time.</p>
                <p>‚Ä¢ Tap the held card to use it immediately (returns to room).</p>
                <p>‚Ä¢ <strong>Strategy:</strong> Hold a weapon to skip it now and equip later, or hold a potion for when you need it most!</p>
            </div>
            
            <div class="tutorial-section">
                <h3>‚ö†Ô∏è Weapon Durability</h3>
                <p>Weapons break after use! Easy: 3 uses | Normal: 2 | Hard: 1</p>
                <p>‚Ä¢ Colored bar shows durability (üü¢ good, üü° medium, üî¥ low)</p>
                <p>‚Ä¢ Repair in shop or find üî® Durable Weapons relic for infinite durability</p>
                <p>‚Ä¢ <strong>‚õî Warning:</strong> Equipping a new weapon breaks your combo!</p>
            </div>
            
            <div class="tutorial-section">
                <h3>üî• Combo System</h3>
                <p><strong>Build combos by killing monsters without taking damage!</strong></p>
                <p>‚Ä¢ <strong>Combo increases:</strong> Perfect kills (no damage taken)</p>
                <p>‚Ä¢ <strong>Combo persists:</strong> Between rooms - keep it going!</p>
                <p>‚Ä¢ <strong>Combo breaks:</strong> Taking damage OR equipping a weapon</p>
                <p>‚Ä¢ <strong>Potions don't break combo</strong> - use them strategically!</p>
                <p>‚Ä¢ <strong>Visual rewards:</strong> 5x = GREAT!, 7x = AMAZING!, 10x = LEGENDARY!</p>
                <p>‚Ä¢ <strong>Score bonus:</strong> Max combo x10 points in final score</p>
            </div>
            
            <div class="tutorial-section">
                <h3>üëπ Boss Battles</h3>
                <p><strong>Every 10th room is a BOSS ROOM!</strong></p>
                <p>‚Ä¢ Bosses have <strong>15 HP</strong> and require multiple hits</p>
                <p>‚Ä¢ <strong>HP bar</strong> shows boss health (üü¢‚Üíüü°‚Üíüî¥)</p>
                <p>‚Ä¢ <strong>‚ö†Ô∏è Critical:</strong> If you fight a boss <strong>WITHOUT a weapon</strong>:</p>
                <p>&nbsp;&nbsp;&nbsp;‚Ä¢ Boss attacks once and flees</p>
                <p>&nbsp;&nbsp;&nbsp;‚Ä¢ You take full damage (15 HP!)</p>
                <p>&nbsp;&nbsp;&nbsp;‚Ä¢ <strong>NO GOLD REWARD</strong></p>
                <p>‚Ä¢ <strong>üí° Strategy:</strong> Always have a weapon before room 10, 20, 30...</p>
            </div>
            
            <div class="tutorial-section">
                <h3>üí∞ Gold & Economy</h3>
                <p>‚Ä¢ <strong>Gold varies by difficulty:</strong> Easy = More | Normal = Balanced | Hard = Much less</p>
                <p>‚Ä¢ Get gold from: Monsters, rooms, relics, events</p>
                <p>‚Ä¢ <strong>üí° Tip:</strong> On Hard mode, every coin counts!</p>
            </div>
            
            <div class="tutorial-section">
                <h3>üè∫ Merchant & üîÆ Relics</h3>
                <p>‚Ä¢ <strong>Merchant:</strong> Click üè∫ MERCHANT to spend gold on heals, relics, and upgrades.</p>
                <p>‚Ä¢ <strong>Relics by Rarity:</strong></p>
                <p>&nbsp;&nbsp;&nbsp;‚ö™ Common (25ü™ô) - Basic bonuses</p>
                <p>&nbsp;&nbsp;&nbsp;üü¢ Uncommon (50ü™ô) - Moderate bonuses</p>
                <p>&nbsp;&nbsp;&nbsp;üîµ Rare (100ü™ô) - Powerful bonuses</p>
                <p>&nbsp;&nbsp;&nbsp;üü† Legendary (200ü™ô) - Game-changing!</p>
                <p>‚Ä¢ <strong>‚ö†Ô∏è Shop Penalty:</strong> Each shop visit costs -50 points in final score</p>
                <p>‚Ä¢ <strong>Events:</strong> üé≤ Random encounters after clearing rooms. Make choices!</p>
                <p>‚Ä¢ <strong>Upgrades:</strong> ‚≠ê Permanent progress that carries over between runs!</p>
            </div>
            
            <div class="tutorial-section">
                <h3>üèÜ Score System</h3>
                <p><strong>Victory score is calculated from multiple factors:</strong></p>
                <p>‚Ä¢ <strong>Base Bonuses:</strong></p>
                <p>&nbsp;&nbsp;&nbsp;üéØ Win Bonus: +1000</p>
                <p>&nbsp;&nbsp;&nbsp;‚ù§Ô∏è Health: HP x 20</p>
                <p>&nbsp;&nbsp;&nbsp;üí∞ Gold: Total earned x 5</p>
                <p>&nbsp;&nbsp;&nbsp;üî• Combo: Max combo x 10</p>
                <p>&nbsp;&nbsp;&nbsp;‚öîÔ∏è Monsters: Slain x 2</p>
                <p>‚Ä¢ <strong>Special Bonuses:</strong></p>
                <p>&nbsp;&nbsp;&nbsp;‚ö° Speedrun: +1000 (<1 min) or +500 (1-5 min)</p>
                <p>&nbsp;&nbsp;&nbsp;üèÜ Perfect Run: +1000 (no damage taken!)</p>
                <p>‚Ä¢ <strong>Penalties:</strong></p>
                <p>&nbsp;&nbsp;&nbsp;‚è±Ô∏è Time: -2 points per second</p>
                <p>&nbsp;&nbsp;&nbsp;üè∫ Shop: -50 per visit</p>
                <p>‚Ä¢ <strong>Difficulty Multiplier:</strong> Easy x1, Normal x1.5, Hard x2.5</p>
            </div>
            
            <div class="tutorial-section" style="background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; padding: 15px; border-radius: 8px;">
                <h3>üí° Pro Tips</h3>
                <p>‚Ä¢ <strong>Combo strategy:</strong> Don't equip weapons mid-combo unless absolutely necessary</p>
                <p>‚Ä¢ <strong>Boss prep:</strong> Always check your weapon before room 10, 20, 30...</p>
                <p>‚Ä¢ <strong>Shop discipline:</strong> Each shop visit costs score - use it wisely!</p>
                <p>‚Ä¢ <strong>Speedrun tip:</strong> <1 minute = +1000 bonus! 1-5 min = +500!</p>
                <p>‚Ä¢ <strong>Perfect run:</strong> Take zero damage for +1000 bonus!</p>
                <p>‚Ä¢ <strong>Hold system:</strong> Save healing potions for emergencies</p>
            </div>
            
            <button class="close-modal-btn" id="btnCloseTutorial">Got it!</button>
        </div>
    </div>
    
    <!-- Modal: Leaderboard -->
    <div class="modal-overlay" id="leaderboardModal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close-btn" onclick="document.getElementById('leaderboardModal').classList.remove('active');">‚úï</button>
            <h2>üèÜ Hall of Fame (Top 10)</h2>
            
            <!-- Difficulty Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                <button class="difficulty-tab active" data-difficulty="easy" onclick="switchLeaderboardDifficulty('easy')">
                    üü¢ Easy
                </button>
                <button class="difficulty-tab" data-difficulty="normal" onclick="switchLeaderboardDifficulty('normal')">
                    üü° Normal
                </button>
                <button class="difficulty-tab" data-difficulty="hard" onclick="switchLeaderboardDifficulty('hard')">
                    üî¥ Hard
                </button>
                <button class="difficulty-tab" data-difficulty="endless" onclick="switchLeaderboardDifficulty('endless')">
                    ‚ôæÔ∏è Endless
                </button>
            </div>
            
            <div id="leaderboardList" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                <p style="text-align: center; color: #aaa;">Loading scores...</p>
            </div>
            <button class="close-modal-btn" id="btnCloseLeaderboard">Close</button>
        </div>
    </div>
    
    <!-- Other Modals (Shop, Event, Unlocks) - Identical structure -->
    <div class="modal-overlay" id="shopModal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeShopWrapper();">‚úï</button>
            <h2>üè∫ Merchant's Wares</h2>
            <p style="text-align: center; color: #aaa; margin-bottom: 20px;">
                Spend your gold wisely! (Gold: <span id="shopGoldAmount">0</span>)
            </p>
            <div id="shopItems" style="max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
            <button class="close-modal-btn" id="btnCloseShop">Leave Shop</button>
        </div>
    </div>

    <div class="modal-overlay" id="eventModal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeEventWrapper();">‚úï</button>
            <h2 id="eventTitle">üé≤ Event</h2>
            <div class="event-text" id="eventText"></div>
            <div id="eventChoices"></div>
            <!-- Close button not needed, choice closes modal -->
        </div>
    </div>

    <div class="modal-overlay" id="unlocksModal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('unlocksModal').classList.remove('active');">‚úï</button>
            <h2>‚≠ê Permanent Upgrades</h2>
            <p style="text-align: center; color: #aaa; margin-bottom: 20px;">
                Progress that continues between runs!
            </p>
            <div id="unlocksList" style="max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
            <button class="close-modal-btn" id="btnCloseUnlocks">Close</button>
        </div>
    </div>
    
    
    <!-- Modal: Achievements -->
    <div class="modal-overlay" id="achievementsModal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="modal-close-btn" onclick="document.getElementById('achievementsModal').classList.remove('active');">‚úï</button>
            <h2>üèÜ Achievements</h2>
            <p style="text-align: center; color: #aaa; margin-bottom: 20px;">
                <span id="achievementStats">0/50 Unlocked</span> | 
                ü•â <span id="bronzeCount">0/25</span> | 
                ü•à <span id="silverCount">0/15</span> | 
                ü•á <span id="goldCount">0/9</span> | 
                üíé <span id="platinumCount">0/1</span>
            </p>
            <div id="achievementsList" class="achievements-grid"></div>
            <button class="close-modal-btn" id="btnCloseAchievements">Close</button>
        </div>
    </div>
    
    <!-- Modal: Soundboard -->
    <div class="modal-overlay" id="soundboardModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close-btn" onclick="document.getElementById('soundboardModal').classList.remove('active');">‚úï</button>
            <h2>üéµ Soundboard - Dark Atmospheric Music</h2>
            <p style="color: #aaa; margin-bottom: 20px;">Preview all atmospheric tracks from the game!</p>
            
            <div style="display: grid; gap: 15px;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 2px solid #8b7355;">
                    <h3 style="color: #d4af37; margin-bottom: 10px;">üè∞ Dark Awakening</h3>
                    <p style="color: #bbb; font-size: 0.9em; margin-bottom: 10px;">Menu Theme - Mysterious, inviting, dark</p>
                    <button class="btn btn-primary" id="btnPlayMenu" style="width: 100%;">‚ñ∂Ô∏è Play</button>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 2px solid #8b7355;">
                    <h3 style="color: #d4af37; margin-bottom: 10px;">‚öîÔ∏è Into the Depths</h3>
                    <p style="color: #bbb; font-size: 0.9em; margin-bottom: 10px;">Gameplay Theme - Tense, adventurous</p>
                    <button class="btn btn-primary" id="btnPlayGameplay" style="width: 100%;">‚ñ∂Ô∏è Play</button>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 2px solid #8b7355;">
                    <h3 style="color: #d4af37; margin-bottom: 10px;">üõçÔ∏è Merchant's Shadow</h3>
                    <p style="color: #bbb; font-size: 0.9em; margin-bottom: 10px;">Shop Theme - Calm but mysterious</p>
                    <button class="btn btn-primary" id="btnPlayShop" style="width: 100%;">‚ñ∂Ô∏è Play</button>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 2px solid #8b7355;">
                    <h3 style="color: #d4af37; margin-bottom: 10px;">üëë Triumph in Darkness</h3>
                    <p style="color: #bbb; font-size: 0.9em; margin-bottom: 10px;">Victory Theme - Epic, celebratory</p>
                    <button class="btn btn-primary" id="btnPlayVictory" style="width: 100%;">‚ñ∂Ô∏è Play</button>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 2px solid #8b7355;">
                    <h3 style="color: #d4af37; margin-bottom: 10px;">üíÄ The Final Darkness</h3>
                    <p style="color: #bbb; font-size: 0.9em; margin-bottom: 10px;">Defeat Theme - Dark, respectful</p>
                    <button class="btn btn-primary" id="btnPlayDefeat" style="width: 100%;">‚ñ∂Ô∏è Play</button>
                </div>
            </div>
            
            <button class="close-modal-btn" id="btnCloseSoundboard" style="margin-top: 20px;">Close</button>
        </div>
    </div>
    
    <!-- Modal: Codex (Unified) -->
    <div class="modal-overlay" id="codexModal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="modal-close-btn" onclick="document.getElementById('codexModal').classList.remove('active');">‚úï</button>
            <h2>üìö CODEX</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <p style="color: #aaa; font-size: 0.95em;">Your complete game encyclopedia</p>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #5a4a38; padding-bottom: 0;">
                <button onclick="switchCodexTab('upgrades')" id="codexTabUpgrades" class="codex-tab active" style="
                    flex: 1;
                    padding: 12px 20px;
                    background: linear-gradient(180deg, #4a3d2f 0%, #342820 100%);
                    border: 2px solid #d4af37;
                    border-bottom: none;
                    border-radius: 8px 8px 0 0;
                    color: #d4af37;
                    font-family: 'Cinzel', serif;
                    font-weight: bold;
                    font-size: 0.95em;
                    cursor: pointer;
                    transition: all 0.2s ease;
                ">‚≠ê UPGRADES</button>
                
                <button onclick="switchCodexTab('relics')" id="codexTabRelics" class="codex-tab" style="
                    flex: 1;
                    padding: 12px 20px;
                    background: linear-gradient(180deg, #3d3328 0%, #2a2318 100%);
                    border: 2px solid #5a4a38;
                    border-bottom: none;
                    border-radius: 8px 8px 0 0;
                    color: #c9a961;
                    font-family: 'Cinzel', serif;
                    font-weight: bold;
                    font-size: 0.95em;
                    cursor: pointer;
                    transition: all 0.2s ease;
                ">üìñ RELICS</button>
                
                <button onclick="switchCodexTab('achievements')" id="codexTabAchievements" class="codex-tab" style="
                    flex: 1;
                    padding: 12px 20px;
                    background: linear-gradient(180deg, #3d3328 0%, #2a2318 100%);
                    border: 2px solid #5a4a38;
                    border-bottom: none;
                    border-radius: 8px 8px 0 0;
                    color: #c9a961;
                    font-family: 'Cinzel', serif;
                    font-weight: bold;
                    font-size: 0.95em;
                    cursor: pointer;
                    transition: all 0.2s ease;
                ">üèÜ ACHIEVEMENTS</button>
            </div>
            
            <!-- Tab Content: Upgrades -->
            <div id="codexContentUpgrades" class="codex-content" style="display: block;">
                <p style="text-align: center; color: #aaa; margin-bottom: 15px;">
                    Permanent progress that continues between runs!
                </p>
                <!-- Status Filter -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="filterUpgradesByStatus('all')" class="upgrade-filter-btn active" data-status="all" style="padding: 8px 16px; background: #4ecdc4; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 1; transition: all 0.2s ease;">All</button>
                    <button onclick="filterUpgradesByStatus('unlocked')" class="upgrade-filter-btn" data-status="unlocked" style="padding: 8px 16px; background: #6bcf7f; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 0.6; transition: all 0.2s ease;">‚úÖ Unlocked</button>
                    <button onclick="filterUpgradesByStatus('available')" class="upgrade-filter-btn" data-status="available" style="padding: 8px 16px; background: #ffd93d; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 0.6; transition: all 0.2s ease;">‚ú® Available</button>
                    <button onclick="filterUpgradesByStatus('locked')" class="upgrade-filter-btn" data-status="locked" style="padding: 8px 16px; background: #888; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 0.6; transition: all 0.2s ease;">üîí Locked</button>
                </div>
                <div id="upgradesList" style="max-height: 450px; overflow-y: auto; padding-right: 10px;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <!-- Tab Content: Relics -->
            <div id="codexContentRelics" class="codex-content" style="display: none;">
                <!-- Rarity Filter -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="filterRelicsByRarity('all')" class="rarity-filter-btn active" data-rarity="all" style="padding: 8px 16px; background: #4ecdc4; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em;">All</button>
                    <button onclick="filterRelicsByRarity('common')" class="rarity-filter-btn" data-rarity="common" style="padding: 8px 16px; background: #aaa; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em;">‚ö™ Common</button>
                    <button onclick="filterRelicsByRarity('uncommon')" class="rarity-filter-btn" data-rarity="uncommon" style="padding: 8px 16px; background: #6bcf7f; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em;">üü¢ Uncommon</button>
                    <button onclick="filterRelicsByRarity('rare')" class="rarity-filter-btn" data-rarity="rare" style="padding: 8px 16px; background: #4a9eff; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em;">üîµ Rare</button>
                    <button onclick="filterRelicsByRarity('legendary')" class="rarity-filter-btn" data-rarity="legendary" style="padding: 8px 16px; background: #ff9800; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em;">üü† Legendary</button>
                </div>
                <div id="relicsGlossary" style="max-height: 450px; overflow-y: auto; padding-right: 10px;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <!-- Tab Content: Achievements -->
            <div id="codexContentAchievements" class="codex-content" style="display: none;">
                <p style="text-align: center; color: #aaa; margin-bottom: 15px;">
                    <span id="achievementStatsCodex">0/50 Unlocked</span> | 
                    ü•â <span id="bronzeCountCodex">0/25</span> | 
                    ü•à <span id="silverCountCodex">0/15</span> | 
                    ü•á <span id="goldCountCodex">0/9</span> | 
                    üíé <span id="platinumCountCodex">0/1</span>
                </p>
                <!-- Tier Filter -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="filterAchievementsByTier('all')" class="achievement-filter-btn active" data-tier="all" style="padding: 8px 16px; background: #4ecdc4; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 1; transition: all 0.2s ease;">All</button>
                    <button onclick="filterAchievementsByTier('bronze')" class="achievement-filter-btn" data-tier="bronze" style="padding: 8px 16px; background: #cd7f32; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 0.6; transition: all 0.2s ease;">ü•â Bronze</button>
                    <button onclick="filterAchievementsByTier('silver')" class="achievement-filter-btn" data-tier="silver" style="padding: 8px 16px; background: #c0c0c0; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 0.6; transition: all 0.2s ease;">ü•à Silver</button>
                    <button onclick="filterAchievementsByTier('gold')" class="achievement-filter-btn" data-tier="gold" style="padding: 8px 16px; background: #ffd700; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 0.6; transition: all 0.2s ease;">ü•á Gold</button>
                    <button onclick="filterAchievementsByTier('platinum')" class="achievement-filter-btn" data-tier="platinum" style="padding: 8px 16px; background: #e5e4e2; border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.85em; opacity: 0.6; transition: all 0.2s ease;">üíé Platinum</button>
                </div>
                <div id="achievementsListCodex" style="max-height: 450px; overflow-y: auto; padding-right: 10px;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <button class="close-modal-btn" onclick="document.getElementById('codexModal').classList.remove('active');" style="margin-top: 20px;">Close</button>
        </div>
    </div>
    
    <!-- Modal: Version / What's New -->
    <div class="modal-overlay" id="versionModal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close-btn" onclick="document.getElementById('versionModal').classList.remove('active');">‚úï</button>
            <h2>üöÄ What's New in v1.4.0</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <p style="color: #6bcf7f; font-size: 1.2em; font-weight: bold;">üéì Tutorial Update!</p>
                <p style="color: #aaa; font-size: 0.9em;">Released: November 9, 2025</p>
            </div>
            
            <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                <!-- Tutorial System -->
                <div style="background: rgba(107, 207, 127, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #6bcf7f;">
                    <h3 style="color: #6bcf7f; margin-top: 0;">üéì 13-Step Interactive Tutorial</h3>
                    <p style="color: #ddd; margin-bottom: 10px;">First-time players on Easy now get a complete guided tutorial!</p>
                    <ul style="color: #ddd; line-height: 1.8; font-size: 0.95em;">
                        <li><strong>Learn All Mechanics:</strong> Health, Gold, Combat, Weapons, Drawing Rooms</li>
                        <li><strong>Unique Features Explained:</strong> Held Cards, Codex, Score System</li>
                        <li><strong>Golden Spotlights:</strong> Important UI elements highlighted with pulsing borders</li>
                        <li><strong>Skip Anytime:</strong> Confirmation modal prevents accidental exits</li>
                        <li><strong>One-Time Only:</strong> Never interrupts experienced players</li>
                    </ul>
                </div>
                
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffd700;">
                    <h3 style="color: #ffd700; margin-top: 0;">‚å®Ô∏è Smart Keyboard Protection</h3>
                    <ul style="color: #ddd; line-height: 1.8;">
                        <li><strong>No Accidental Shortcuts:</strong> All game keys blocked during tutorial</li>
                        <li><strong>Navigation Keys Work:</strong> Space, Arrows, ESC still functional</li>
                        <li><strong>Safe Exit:</strong> ESC opens skip confirmation (not instant close)</li>
                        <li><strong>Auto-Restore:</strong> Normal shortcuts return after tutorial</li>
                    </ul>
                </div>
                
                <div style="background: rgba(78, 205, 196, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4ecdc4;">
                    <h3 style="color: #4ecdc4; margin-top: 0;">‚ú® Visual Polish</h3>
                    <ul style="color: #ddd; line-height: 1.8;">
                        <li><strong>Perfect Alignment:</strong> Bottom-right buttons now properly spaced</li>
                        <li><strong>Dark Overlays:</strong> All tutorial modals have consistent backgrounds</li>
                        <li><strong>Interactive Spotlights:</strong> Highlighted elements remain clickable</li>
                        <li><strong>Better Focus:</strong> Professional dark mode during tutorial steps</li>
                    </ul>
                </div>
                
                <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b6b;">
                    <h3 style="color: #ff6b6b; margin-top: 0;">üêõ Bug Fixes</h3>
                    <ul style="color: #ddd; line-height: 1.8;">
                        <li>Fixed spotlight blocking highlighted elements</li>
                        <li>Fixed keyboard shortcuts leaking during tutorial</li>
                        <li>Fixed ESC key behavior (now shows confirmation)</li>
                        <li>Fixed missing dark overlay on some tutorial modals</li>
                        <li><strong>Fixed/New:</strong> Cloud saves now work as should! Connect with Google account</li>
                    </ul>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                <p style="color: #ffd700; font-weight: bold; margin: 0;">üéì The Best Onboarding Experience Yet!</p>
                <p style="color: #aaa; font-size: 0.9em; margin-top: 10px;">New players learn faster ‚Ä¢ Unique mechanics explained ‚Ä¢ Professional polish</p>
            </div>
            
            <div style="text-align: center; margin-top: 15px; padding: 12px; background: rgba(78, 205, 196, 0.08); border-radius: 8px;">
                <p style="color: #4ecdc4; font-weight: bold; margin: 0; font-size: 0.95em;">üôè Special Thanks</p>
                <p style="color: #aaa; font-size: 0.85em; margin-top: 8px; line-height: 1.6;">
                    Thanks to all new players who requested better onboarding!<br>
                    <span style="font-size: 0.9em;">Your feedback drives improvement! üéÆ‚ú®</span>
                </p>
            </div>
            
            <button class="close-modal-btn" id="btnCloseVersion" onclick="document.getElementById('versionModal').classList.remove('active');">Got it!</button>
        </div>
    </div>
    
    <!-- Modal: Bug Report -->
    <div class="modal-overlay" id="bugReportModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close-btn" onclick="document.getElementById('bugReportModal').classList.remove('active'); hideHumanVerification();">‚úï</button>
            <h2>üêõ Report a Bug</h2>
            <div style="margin: 10px 0 12px; color: #aaa; font-size: 0.9em;">Describe the bug in detail. Technical info like browser and screen resolution will be sent automatically.</div>
            <textarea id="bugMessage" placeholder="Describe what happened, steps to reproduce, and expected behavior" style="width: 100%; min-height: 160px; resize: vertical; background: rgba(0,0,0,0.4); color: #ddd; border: 1px solid rgba(201,169,97,0.3); border-radius: 6px; padding: 10px;" oninput="updateCharacterCount()"></textarea>
            
            <!-- Character counter and validation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 0.85em;">
                <div id="validationMessage" style="color: #ff6b6b; display: none;"></div>
                <div id="characterCount" style="color: #aaa;">0 / 2000</div>
            </div>
            
            <!-- Optional email for copy -->
            <div style="margin-top: 15px; padding: 12px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #ddd;">
                    <input 
                        type="checkbox" 
                        id="sendCopyCheckbox" 
                        onchange="toggleEmailField()"
                        style="width: 16px; height: 16px; accent-color: #ffd700;"
                    >
                    <span style="font-size: 0.9em;">Send me a copy of this bug report</span>
                </label>
                <input 
                    type="email" 
                    id="userEmail" 
                    placeholder="your.email@example.com" 
                    style="width: 100%; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.4); color: #ddd; border: 1px solid rgba(201,169,97,0.3); border-radius: 4px; display: none;"
                    oninput="validateEmail()"
                >
                <div id="emailValidation" style="color: #ff6b6b; font-size: 0.8em; margin-top: 5px; display: none;"></div>
            </div>
            
            <!-- Human Verification Section -->
            <div id="humanVerification" style="margin-top: 15px; padding: 12px; background: rgba(107, 207, 127, 0.1); border: 1px solid rgba(107, 207, 127, 0.3); border-radius: 6px; display: none;">
                <div style="color: #6bcf7f; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                    ü§ñ <span>Human Verification</span>
                </div>
                <div style="color: #ddd; font-size: 0.9em; margin-bottom: 10px;">
                    Please solve this simple math problem to verify you're human:
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="mathQuestion" style="color: #ffd700; font-size: 1.1em; font-weight: bold;"></span>
                    <input 
                        type="number" 
                        id="mathAnswer" 
                        placeholder="Answer"
                        style="width: 80px; padding: 6px; background: rgba(0,0,0,0.4); color: #ddd; border: 1px solid rgba(201,169,97,0.3); border-radius: 4px; text-align: center;"
                    >
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 14px;">
                <button class="close-modal-btn" onclick="document.getElementById('bugReportModal').classList.remove('active'); hideHumanVerification();">Cancel</button>
                <button 
                    id="bugReportSubmit"
                    class="close-modal-btn" 
                    onclick="sendBugReport()"
                    style="background: linear-gradient(135deg, #6bcf7f, #2fbf71); border: none; color: #102015; cursor: pointer;">
                    Send
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // MOBILE DETECTION & WAITLIST SYSTEM
        // ============================================
        
        // Detect if device is mobile
        function isMobileDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
            const isMobile = mobileRegex.test(userAgent);
            const isSmallScreen = window.innerWidth <= 768;
            return isMobile || isSmallScreen;
        }
        
        // Check if user dismissed mobile warning
        function hasDismissedMobileWarning() {
            const dismissed = localStorage.getItem('dismissedMobileWarning');
            if (!dismissed) return false;
            
            // Check if dismissed more than 7 days ago
            const dismissedTime = parseInt(dismissed);
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            return dismissedTime > sevenDaysAgo;
        }
        
        // Show mobile waitlist modal
        function showMobileWaitlist() {
            if (isMobileDevice() && !hasDismissedMobileWarning()) {
                document.getElementById('mobileWaitlistModal').classList.add('active');
                // Prevent scrolling on body
                document.body.style.overflow = 'hidden';
            }
        }
        
        // Dismiss mobile warning
        function dismissMobileWarning() {
            localStorage.setItem('dismissedMobileWarning', Date.now().toString());
            document.getElementById('mobileWaitlistModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Join waitlist function
        window.joinWaitlist = function() {
            const emailInput = document.getElementById('waitlistEmail');
            const privacyCheckbox = document.getElementById('waitlistPrivacy');
            const marketingCheckbox = document.getElementById('waitlistMarketing');
            const validationDiv = document.getElementById('waitlistValidation');
            const successDiv = document.getElementById('waitlistSuccess');
            const submitBtn = event.target;
            
            // Clear previous validation
            validationDiv.style.display = 'none';
            
            // Get values
            const email = emailInput.value.trim();
            
            // Validate email
            if (!email) {
                validationDiv.textContent = 'Please enter your email address.';
                validationDiv.style.display = 'block';
                emailInput.focus();
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                validationDiv.textContent = 'Please enter a valid email address.';
                validationDiv.style.display = 'block';
                emailInput.focus();
                return;
            }
            
            // Validate checkboxes
            if (!privacyCheckbox.checked) {
                validationDiv.textContent = 'You must accept the Privacy Policy to continue.';
                validationDiv.style.display = 'block';
                return;
            }
            
            if (!marketingCheckbox.checked) {
                validationDiv.textContent = 'You must accept to receive updates to join the waitlist.';
                validationDiv.style.display = 'block';
                return;
            }
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Joining...';
            
            // Prepare EmailJS params
            const params = {
                from_name: 'Mobile Waitlist',
                reply_to: email,
                user_email: email,
                signup_date: new Date().toLocaleString(),
                privacy_accepted: 'Yes',
                marketing_accepted: 'Yes',
                device_info: navigator.userAgent,
                screen_size: `${window.innerWidth}x${window.innerHeight}`,
                message: `New mobile waitlist signup from ${email}`
            };
            
            console.log('Sending waitlist signup:', params);
            
            // Send via EmailJS (using waitlist template)
            if (window.emailjs) {
                emailjs.send('service_tfl51qs', 'template_hif1mc1', params)
                    .then(function(response) {
                        console.log('Waitlist signup SUCCESS:', response);
                        
                        // Show success message
                        successDiv.style.display = 'block';
                        emailInput.value = '';
                        privacyCheckbox.checked = false;
                        marketingCheckbox.checked = false;
                        
                        // Store in localStorage to prevent duplicate signups
                        localStorage.setItem('waitlistSignup', email);
                        
                        // Auto-dismiss after 3 seconds
                        setTimeout(() => {
                            dismissMobileWarning();
                        }, 3000);
                        
                    }, function(error) {
                        console.error('Waitlist signup FAILED:', error);
                        validationDiv.textContent = 'Failed to join waitlist. Please try again.';
                        validationDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.textContent = '‚ú® Join Waitlist';
                    });
            } else {
                console.error('EmailJS not loaded');
                validationDiv.textContent = 'Email service not available. Please try again later.';
                validationDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = '‚ú® Join Waitlist';
            }
        };
        
        // Show modal on page load if mobile
        window.addEventListener('DOMContentLoaded', function() {
            showMobileWaitlist();
        });
        
        // ============================================
        // BUG REPORT SYSTEM
        // ============================================
        
        // Anti-bot protection storage
        let bugReportAttempts = JSON.parse(localStorage.getItem('bugReportAttempts') || '[]');
        let lastBugReportTime = parseInt(localStorage.getItem('lastBugReportTime') || '0');
        let currentMathAnswer = 0;
        
        // Show human verification when needed
        function showHumanVerification() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            currentMathAnswer = num1 + num2;
            
            document.getElementById('mathQuestion').textContent = `${num1} + ${num2} = ?`;
            document.getElementById('mathAnswer').value = '';
            document.getElementById('humanVerification').style.display = 'block';
            
            // Focus on answer input
            setTimeout(() => {
                document.getElementById('mathAnswer').focus();
            }, 100);
        }
        
        // Hide human verification
        function hideHumanVerification() {
            document.getElementById('humanVerification').style.display = 'none';
            // Also clear validation messages
            const validationDiv = document.getElementById('validationMessage');
            if (validationDiv) validationDiv.style.display = 'none';
            
            // Reset email field
            document.getElementById('sendCopyCheckbox').checked = false;
            document.getElementById('userEmail').style.display = 'none';
            document.getElementById('emailValidation').style.display = 'none';
        }
        
        // Toggle email field visibility
        function toggleEmailField() {
            const checkbox = document.getElementById('sendCopyCheckbox');
            const emailField = document.getElementById('userEmail');
            const emailValidation = document.getElementById('emailValidation');
            
            if (checkbox.checked) {
                emailField.style.display = 'block';
                setTimeout(() => emailField.focus(), 100);
            } else {
                emailField.style.display = 'none';
                emailField.value = '';
                emailValidation.style.display = 'none';
                emailField.style.borderColor = 'rgba(201,169,97,0.3)';
            }
        }
        
        // Validate email format
        function validateEmail() {
            const emailField = document.getElementById('userEmail');
            const emailValidation = document.getElementById('emailValidation');
            const email = emailField.value.trim();
            
            if (!email) {
                emailValidation.style.display = 'none';
                emailField.style.borderColor = 'rgba(201,169,97,0.3)';
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(email)) {
                emailValidation.style.display = 'none';
                emailField.style.borderColor = '#6bcf7f';
            } else {
                emailValidation.textContent = 'Please enter a valid email address';
                emailValidation.style.display = 'block';
                emailField.style.borderColor = '#ff6b6b';
            }
        }
        
        // Update character count and validation
        function updateCharacterCount() {
            const textarea = document.getElementById('bugMessage');
            const countDiv = document.getElementById('characterCount');
            const validationDiv = document.getElementById('validationMessage');
            
            const length = textarea.value.length;
            countDiv.textContent = `${length} / 2000`;
            
            // Visual feedback for character count
            if (length > 2000) {
                countDiv.style.color = '#ff6b6b';
                textarea.style.borderColor = '#ff6b6b';
                validationDiv.textContent = 'Message too long (max 2000 characters)';
                validationDiv.style.display = 'block';
            } else if (length < 10 && length > 0) {
                countDiv.style.color = '#ffd700';
                textarea.style.borderColor = '#ffd700';
                validationDiv.textContent = 'Please provide more details (min 10 characters)';
                validationDiv.style.display = 'block';
            } else if (length >= 10) {
                countDiv.style.color = '#6bcf7f';
                textarea.style.borderColor = 'rgba(201,169,97,0.3)';
                validationDiv.style.display = 'none';
            } else {
                countDiv.style.color = '#aaa';
                textarea.style.borderColor = 'rgba(201,169,97,0.3)';
                validationDiv.style.display = 'none';
            }
        }
        
        // Show rate limit message inline
        function showRateLimitMessage(message) {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.textContent = message;
            validationDiv.style.color = '#ffd700';
            validationDiv.style.display = 'block';
        }
        
        // Enhanced browser detection
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            let browserName = 'Unknown';
            let browserVersion = 'Unknown';
            let os = 'Unknown';
            
            // Browser detection
            if (ua.includes('Firefox/')) {
                browserName = 'Firefox';
                browserVersion = ua.match(/Firefox\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Chrome/') && !ua.includes('Edg/')) {
                browserName = 'Chrome';
                browserVersion = ua.match(/Chrome\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Edg/')) {
                browserName = 'Edge';
                browserVersion = ua.match(/Edg\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Safari/') && !ua.includes('Chrome')) {
                browserName = 'Safari';
                browserVersion = ua.match(/Version\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Opera/') || ua.includes('OPR/')) {
                browserName = 'Opera';
                browserVersion = ua.match(/(?:Opera|OPR)\/(\d+)/)?.[1] || 'Unknown';
            }
            
            // OS detection
            if (ua.includes('Windows')) {
                os = 'Windows';
                if (ua.includes('Windows NT 10.0')) os = 'Windows 10/11';
                else if (ua.includes('Windows NT 6.1')) os = 'Windows 7';
            } else if (ua.includes('Mac OS')) {
                os = 'macOS';
                const macVersion = ua.match(/Mac OS X ([0-9_]+)/)?.[1]?.replace(/_/g, '.');
                if (macVersion) os = `macOS ${macVersion}`;
            } else if (ua.includes('Linux')) {
                os = 'Linux';
            } else if (ua.includes('Android')) {
                os = 'Android';
                const androidVersion = ua.match(/Android (\d+)/)?.[1];
                if (androidVersion) os = `Android ${androidVersion}`;
            } else if (ua.includes('iOS') || ua.includes('iPhone') || ua.includes('iPad')) {
                os = 'iOS';
                const iosVersion = ua.match(/OS (\d+_\d+)/)?.[1]?.replace(/_/g, '.');
                if (iosVersion) os = `iOS ${iosVersion}`;
            }
            
            return {
                name: browserName,
                version: browserVersion,
                os: os,
                full: `${browserName} ${browserVersion} on ${os}`
            };
        }
        
        // Enhanced screen detection
        function getScreenInfo() {
            const screenWidth = window.screen.width;
            const screenHeight = window.screen.height;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const pixelRatio = window.devicePixelRatio || 1;
            
            // Device type detection
            let deviceType = 'Desktop';
            if (window.innerWidth <= 768) {
                deviceType = 'Mobile';
            } else if (window.innerWidth <= 1024) {
                deviceType = 'Tablet';
            }
            
            return {
                resolution: `${screenWidth}x${screenHeight}`,
                viewport: `${viewportWidth}x${viewportHeight}`,
                device: deviceType,
                pixelRatio: pixelRatio,
                screenWidth: screenWidth,
                screenHeight: screenHeight,
                viewportWidth: viewportWidth,
                viewportHeight: viewportHeight
            };
        }
        
        // Bug Report Function (Global Scope)
        window.sendBugReport = function() {
            console.log('sendBugReport called');
            try {
                const now = Date.now();
                
                // RATE LIMITING: Max 1 report per 5 minutes
                if (now - lastBugReportTime < 5 * 60 * 1000) {
                    const remainingTime = Math.ceil((5 * 60 * 1000 - (now - lastBugReportTime)) / 1000 / 60);
                    showRateLimitMessage(`Please wait ${remainingTime} minutes before sending another bug report.`);
                    return;
                }
                
                // DAILY LIMIT: Max 3 reports per day
                const today = new Date().toDateString();
                const todayAttempts = bugReportAttempts.filter(attempt => 
                    new Date(attempt).toDateString() === today
                ).length;
                
                if (todayAttempts >= 3) {
                    showRateLimitMessage('Daily limit reached. You can send up to 3 bug reports per day.');
                    return;
                }
                
                // Check if human verification is needed
                const verificationDiv = document.getElementById('humanVerification');
                if (verificationDiv.style.display === 'none' || !verificationDiv.style.display) {
                    // First click - show verification
                    showHumanVerification();
                    return;
                }
                
                // HUMAN VERIFICATION: Check answer
                const userAnswer = parseInt(document.getElementById('mathAnswer').value);
                if (!userAnswer || userAnswer !== currentMathAnswer) {
                    // Shake the input field for visual feedback
                    const answerInput = document.getElementById('mathAnswer');
                    answerInput.style.animation = 'shake 0.5s';
                    answerInput.style.borderColor = '#ff6b6b';
                    setTimeout(() => {
                        answerInput.style.animation = '';
                        answerInput.style.borderColor = 'rgba(201,169,97,0.3)';
                    }, 500);
                    return;
                }
                const textarea = document.getElementById('bugMessage');
                if (!textarea) { 
                    console.error('bugMessage textarea not found');
                    showRateLimitMessage('Bug report system unavailable. Please try again later.');
                    return; 
                }
                const message = (textarea.value || '').trim();
                console.log('Message:', message);
                
                // Simple anti-spam validation (visual feedback already handled by updateCharacterCount)
                if (!message) { 
                    showRateLimitMessage('Please describe the bug.');
                    textarea.focus();
                    return; 
                }
                if (message.length < 10) {
                    showRateLimitMessage('Please provide more details (at least 10 characters).');
                    textarea.focus();
                    return;
                }
                if (message.length > 2000) {
                    showRateLimitMessage('Message too long. Please keep it under 2000 characters.');
                    textarea.focus();
                    return;
                }
                
                // Simple spam detection
                const spamWords = ['viagra', 'casino', 'lottery', 'winner', 'click here', 'free money'];
                const lowerMessage = message.toLowerCase();
                if (spamWords.some(word => lowerMessage.includes(word))) {
                    showRateLimitMessage('Message contains inappropriate content.');
                    textarea.focus();
                    return;
                }
                
                console.log('Checking emailjs:', window.emailjs);
                if (!window.emailjs) { 
                    showRateLimitMessage('Email service not loaded. Please refresh the page and try again.');
                    return; 
                }
                
                // Check if user wants email copy and validate
                const sendCopyCheckbox = document.getElementById('sendCopyCheckbox');
                const userEmail = document.getElementById('userEmail');
                let userEmailValue = '';
                
                if (sendCopyCheckbox.checked) {
                    userEmailValue = userEmail.value.trim();
                    if (!userEmailValue) {
                        showRateLimitMessage('Please enter your email address or uncheck "Send me a copy".');
                        userEmail.focus();
                        return;
                    }
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(userEmailValue)) {
                        showRateLimitMessage('Please enter a valid email address.');
                        userEmail.focus();
                        return;
                    }
                }
                
                // Better browser and screen detection
                const browserInfo = getBrowserInfo();
                const screenInfo = getScreenInfo();
                
                const params = {
                    from_name: 'Player',
                    reply_to: userEmailValue || 'player@game.com',
                    message: message,
                    user_browser: browserInfo.full,
                    user_screen: screenInfo.resolution,
                    game_version: 'v1.4.0',
                    report_date: new Date().toLocaleString(),
                    // Alternative names in case template uses these
                    browser: browserInfo.full,
                    screen: screenInfo.resolution,
                    version: 'v1.4.0',
                    date: new Date().toLocaleString(),
                    // Enhanced debugging info
                    browser_name: browserInfo.name,
                    browser_version: browserInfo.version,
                    browser_os: browserInfo.os,
                    screen_viewport: screenInfo.viewport,
                    screen_device: screenInfo.device,
                    screen_pixel_ratio: screenInfo.pixelRatio,
                    // User email for copy (always included, empty if not provided)
                    user_email: userEmailValue,
                    send_copy: userEmailValue ? 'Yes' : 'No',
                    copy_message: userEmailValue ? 'üìß A copy of this report has been sent to your email.' : ''
                };
                
                console.log('Sending email with params:', params);
                console.log('Browser Info:', browserInfo);
                console.log('Screen Info:', screenInfo);
                console.log('Service ID: service_tfl51qs, Template ID: template_x3cplm6');
                
                emailjs.send('service_tfl51qs', 'template_x3cplm6', params)
                    .then(function(response) {
                        console.log('EmailJS SUCCESS:', response);
                        
                        // Update rate limiting data
                        lastBugReportTime = now;
                        bugReportAttempts.push(now);
                        
                        // Keep only last 30 days of attempts
                        const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);
                        bugReportAttempts = bugReportAttempts.filter(time => time > thirtyDaysAgo);
                        
                        // Save to localStorage
                        localStorage.setItem('lastBugReportTime', lastBugReportTime.toString());
                        localStorage.setItem('bugReportAttempts', JSON.stringify(bugReportAttempts));
                        
                        // Clean up and close modal
                        const modal = document.getElementById('bugReportModal');
                        if (modal) modal.classList.remove('active');
                        textarea.value = '';
                        hideHumanVerification(); // Reset verification for next time
                        showBugReportSuccess();
                    })
                    .catch(function(err) {
                        console.error('EmailJS FAILED:', err);
                        console.error('Error status:', err.status);
                        console.error('Error text:', err.text);
                        showBugReportError(err.text || err.status || 'Unknown error');
                    });
            } catch (e) {
                console.error('sendBugReport exception:', e);
                alert('Unexpected error: ' + e.message);
            }
        };
        
        // Elegant feedback for bug report
        function showBugReportSuccess() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '10000';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 450px; border: 3px solid #6bcf7f; animation: modalSlideIn 0.3s ease;">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 4em; margin-bottom: 15px;">‚úÖ</div>
                        <h2 style="color: #6bcf7f; margin: 0 0 15px 0;">Bug Report Sent!</h2>
                        <p style="color: #ddd; font-size: 1.1em; line-height: 1.6; margin: 0 0 20px 0;">
                            Thank you for helping improve Dungeon Scoundrel!<br>
                            Your report has been received.
                        </p>
                        <button class="close-modal-btn" onclick="this.closest('.modal-overlay').remove();" style="background: linear-gradient(135deg, #6bcf7f, #2fbf71); border: none; color: #102015; font-size: 1.1em; padding: 12px 32px;">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 5000);
        }
        
        function showBugReportError(errorMsg) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '10000';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 450px; border: 3px solid #ff6b6b; animation: modalSlideIn 0.3s ease;">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 4em; margin-bottom: 15px;">‚ùå</div>
                        <h2 style="color: #ff6b6b; margin: 0 0 15px 0;">Failed to Send</h2>
                        <p style="color: #ddd; font-size: 1em; line-height: 1.6; margin: 0 0 10px 0;">
                            Could not send the bug report.
                        </p>
                        <p style="color: #aaa; font-size: 0.9em; margin: 0 0 20px 0;">
                            Error: ${errorMsg}
                        </p>
                        <button class="close-modal-btn" onclick="this.closest('.modal-overlay').remove();" style="font-size: 1.1em; padding: 12px 32px;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        // Check EmailJS on page load
        console.log('EmailJS loaded?', !!window.emailjs);
    </script>
    
    <!-- Modal: Give Up -->
    <div class="modal-overlay" id="giveUpModal">
        <div class="modal-content" style="max-width: 500px; border: 3px solid #ff6b6b;">
            <button class="modal-close-btn" onclick="document.getElementById('giveUpModal').classList.remove('active');">‚úï</button>
            <h2 style="color: #ff6b6b;">üè≥Ô∏è GIVE UP?</h2>
            <p style="text-align: center; color: #ddd; font-size: 1.1em; margin: 20px 0;">
                Are you sure you want to end this run?<br>
                Your progress will be lost and your score will be 0.
            </p>
            <div class="modal-controls" style="gap: 15px;">
                <button class="btn btn-secondary" id="btnCancelGiveUp" onclick="document.getElementById('giveUpModal').classList.remove('active');">Cancel</button>
                <button class="btn btn-danger" id="btnConfirmGiveUp" style="background: #ff6b6b; border-color: #ff6b6b;" onclick="confirmGiveUp();">Give Up</button>
            </div>
        </div>
    </div>
    
    <!-- Game Over Overlay (will be created via JS) -->
    
    <!-- ============================================ -->
    <!-- FIREBASE CONFIG (Inline to avoid Netlify secrets scanning)
    <!-- ============================================ -->
    <script>
        // Firebase config - API keys are safe to be public (protected by Firestore rules)
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyAXQOgiVFS04xU196ANWLu9wHrDRWfpjHw",
            authDomain: "dungeon-scoundrel.firebaseapp.com",
            projectId: "dungeon-scoundrel",
            storageBucket: "dungeon-scoundrel.firebasestorage.app",
            messagingSenderId: "13386790249",
            appId: "1:13386790249:web:87cc9a44a310b2e86a79f8"
        });
        window.__app_id = "dungeon_scoundrel_v1";
    </script>
    
    <!-- ============================================ -->
    <!-- GAME SCRIPT (includes CODEX system)
    <!-- ============================================ -->
        <script type="module" src="../src/js/game.js"></script>
    
    <!-- Mobile Orientation Warning -->
    <div id="orientationWarning" style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 99999;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
    ">
        <div style="font-size: 4em; margin-bottom: 20px;">üì±</div>
        <h2 style="color: #c9a961; font-family: 'Cinzel', serif; margin-bottom: 15px;">
            Rotate Your Device
        </h2>
        <p style="color: #ddd; font-family: 'Cinzel', serif; max-width: 400px; line-height: 1.6;">
            This game is best experienced in landscape mode. Please rotate your device for the optimal experience.
        </p>
        <div style="font-size: 3em; margin-top: 20px; animation: spin 2s linear infinite;">
            üîÑ
        </div>
    </div>
    
</body>
</html>

